WITH 
  novos_clientes AS (
  SELECT 
    Polo,
    COUNT(stonecode) as novos_clientes,
    Tier_Estimado
  FROM `ctra-comercial-1554819299431.sandbox_pricing.Plano_Stone_Clientes` 
  WHERE 1=1
    AND Data_de_Credenciamento >= '2022-10-01'
    AND Subcanal = 'FRANQUIA'
  GROUP BY 
    Polo,
    Tier_Estimado
),

hc AS (
  SELECT
    LAST_DAY(hc.Data) AS mes_ref,
    Grupo_3 as Polo,
    SUM((CASE WHEN EXTRACT (DAYOFWEEK from Data)=7 THEN 0.5 ELSE 1 END) * Ativo) as Time_Ativo
  FROM
    `ctra-comercial-1554819299431.metabase_planejamento_central.analitico_headcount_v2` hc
  WHERE
    hc.Data >= '2022-10-01'
    and Subcanal = 'FRANQUIA'
  GROUP BY
    LAST_DAY(hc.Data),
    Polo
)

  SELECT
    hc.mes_ref,
    novos_clientes.Polo,
    novos_clientes.novos_clientes,
    novos_clientes.Tier_Estimado,
    hc.Time_Ativo
  FROM novos_clientes
  JOIN hc
  ON novos_clientes.Polo = hc.Polo
  WHERE 1=1
